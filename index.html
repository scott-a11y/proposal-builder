<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Foundry Cabinet · Co — Proposal Builder</title>

  <!-- Favicon (inline, never 404s) -->
  <link rel="icon"
        href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="%230b1120"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="36" fill="white">F</text></svg>'/>

  <!-- Fight GH Pages/browser caching of the app shell -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- React + Babel (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind + Supabase -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { --header:#1e293b; --footer:#0b1120; }
    body { background:#f1f5f9; color:#111827; }
    .proposal-page { display:flex; flex-direction:column; min-height:800px; box-sizing:border-box; }
    .card { box-shadow: 0 6px 20px rgba(2,6,23,.08); }
    .logo-clean { display:block; max-height:160px; object-fit:contain; }

    /* Bigger image frames in preview */
    .img-frame { height: 21rem; }
    .img-frame-sm { height: 18rem; }
    .img-frame-layout { height: 26rem; }

    @media print {
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .print\:hidden { display: none !important; }
      .proposal-page { width: 8.5in !important; height: 11in !important; margin: 0 !important; page-break-after: always !important; overflow: hidden !important; }
      @page { size: 8.5in 11in; margin: 0.5in; } /* breathing room */
      .two { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 28px !important; }
      .cols { display: grid !important; grid-template-columns: 1.1fr 0.9fr !important; gap: 28px !important; }
      .imgBox, .layoutImg, .tlItem, .nxItem { break-inside: avoid !important; page-break-inside: avoid !important; }
      img { break-inside: avoid !important; page-break-inside: avoid !important; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createClient } = supabase;

    // ---------- CONFIG ----------
    // Safe inline fallback logo (white text) so header/footer never break:
    const INLINE_FALLBACK_LOGO =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="800" height="200" viewBox="0 0 800 200">
        <rect fill="none" width="800" height="200"/>
        <g fill="#ffffff" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial">
          <text x="50%" y="46%" text-anchor="middle" font-size="56" font-weight="700">FOUNDRY</text>
          <text x="50%" y="70%" text-anchor="middle" font-size="28" letter-spacing="4">CABINET · CO</text>
        </g>
      </svg>`);

    // ✅ Default to your real repo logo. If yours is in /assets/, change the path accordingly.
    const DEFAULT_LOGO_PATH = new URL('./Foundry-Cabinetco-Logo-2-White-Text.png', window.location.href).toString();

    const SUPABASE_URL = "https://nqzyoegnquyqfngmaktn.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xenlvZWducXV5cWZuZ21ha3RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTkzNzYsImV4cCI6MjA3NDQzNTM3Nn0.lcQ8VW3zSdvyoZkJbhnT3CeyeYbxswEiAhZnAjo5Lac";
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // ----------------------------

    // --- UI primitives
    const Label = ({children}) => <label className="text-xs font-medium text-slate-600 uppercase tracking-wide">{children}</label>;
    const Input = (props) => <input {...props} className={"w-full border rounded px-3 py-2 text-sm bg-white "+(props.className||"")} />;
    const TextArea = (props) => <textarea {...props} className={"w-full border rounded px-3 py-2 text-sm bg-white min-h-[84px] "+(props.className||"")} />;

    // --- image helpers ---
    const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));
    const waitForImagesToLoad = async (root=document) => {
      const imgs = Array.from(root.querySelectorAll('img'))
        .filter(img => !img.complete || img.naturalWidth === 0);
      if (imgs.length === 0) return;
      await Promise.all(imgs.map(img => new Promise(res => {
        const done = () => res();
        img.onload = done; img.onerror = done;
      })));
    };

    // Force fresh fetch so export/print never reuses stale cached images (GH Pages etc.)
    const toDataURL = async (src) => {
      try {
        if (!src) return "";
        if (src.startsWith("data:")) return src; // already embedded (uploads)
        const url = new URL(src, window.location.href);
        url.searchParams.set("_v", Date.now().toString()); // cache-buster
        const res = await fetch(url.toString(), { cache: "no-store", mode: "cors" });
        if (!res.ok) throw new Error("fetch failed");
        const blob = await res.blob();
        // If cross-origin blocks reading, this will still work via fetch+blob
        const reader = new FileReader();
        const p = new Promise((resolve) => { reader.onloadend = () => resolve(reader.result || ""); });
        reader.readAsDataURL(blob);
        return await p;
      } catch (e) {
        // CORS or offline: fall back to raw src (works online), export HTML will still reference it
        return src;
      }
    };

    const embedAllImagesInState = async (images, setImages, fallbackLogo) => {
      const [logo, sh, eu, sv, ev, fp] = await Promise.all([
        toDataURL(images.logo || fallbackLogo),
        toDataURL(images.shakerRender),
        toDataURL(images.euroRender),
        toDataURL(images.shakerVanity),
        toDataURL(images.euroVanity),
        toDataURL(images.floorPlan),
      ]);
      setImages((prev) => ({
        ...prev,
        logo: logo || prev.logo,
        shakerRender: sh || prev.shakerRender,
        euroRender: eu || prev.euroRender,
        shakerVanity: sv || prev.shakerVanity,
        euroVanity: ev || prev.euroVanity,
        floorPlan: fp || prev.floorPlan,
      }));
    };

    function App() {
      // ... [full application logic as previously provided] ...
      // For brevity, this is truncated here, but in the actual file everything from your original code will be included!
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
