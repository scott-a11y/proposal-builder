<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundry Cabinet Co. - Proposal Builder</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .print\\:hidden { display: none !important; }
            .proposal-page { width: 8.5in !important; height: 11in !important; margin: 0 !important; page-break-after: always !important; overflow: hidden !important; }
            @page { size: 8.5in 11in; margin: 0.25in; }
            .proposal-container, body { background: white !important; }
            body { font-size: 12px !important; }
        }
        .proposal-page { display: flex; flex-direction: column; min-height: 800px; box-sizing: border-box; }
        .timeline-item { display: flex !important; align-items: flex-start !important; margin-bottom: 1.5rem !important; page-break-inside: avoid !important; }
        .content-section { overflow-wrap: break-word; word-wrap: break-word; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { createClient } = supabase;
        const SUPABASE_URL = 'https://nqzyoegnquyqfngmaktn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xenlvZWducXV5cWZuZ21ha3RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTkzNzYsImV4cCI6MjA3NDQzNTM3Nn0.lcQ8VW3zSdvyoZkJbhnT3CeyeYbxswEiAhZnAjo5Lac';
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const { useState, useEffect } = React;

        function ProposalBuilder() {
            const urlParams = new URLSearchParams(window.location.search);
            const isClientMode = urlParams.get('client') === 'true';

            const [savedProposals, setSavedProposals] = useState([]);
            const [currentProposalName, setCurrentProposalName] = useState('');
            const [showLoadDialog, setShowLoadDialog] = useState(false);
            const [images, setImages] = useState({ logo: null, shakerRender: null, euroRender: null, shakerVanity: null, euroVanity: null, floorPlan: null });
            const [content, setContent] = useState({
                title: "Custom Cabinet Proposal – Forest Grove, Oregon",
                projectNumber: "FCB-2025-001",
                date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                clientName: "Valued Client",
                executiveSummary: "We are pleased to present this proposal for custom cabinetry for your Forest Grove home. Our proposal includes two distinct style options: classic Shaker and modern Euro/Flat Panel designs, allowing you to choose the perfect aesthetic for your space.",
                totalInvestment: "$7,595",
                warrantyYears: "3",
                warrantyText: "This comprehensive package includes professional build, delivery, and installation services, all backed by our 3-year workmanship warranty for your complete peace of mind.",
                shakerDescription: "Classic framed doors with recessed panels. Painted finish.",
                euroDescription: "Modern frameless full-overlay doors. Unpainted for customization.",
                shakerVanityDescription: "Classic framed vanity doors with recessed panels. Painted finish.",
                euroVanityDescription: "Modern frameless full-overlay vanity doors. Unpainted for customization.",
                floorPlanDescription: "Plan view showing placement of sink, dishwasher, refrigerator, range, and island cabinetry.",
                onlinePlansLink: "",
                sketchupLink: "",
                closingNote: "Thank you for considering Foundry Cabinet Co. We look forward to creating cabinetry that's the perfect fit for your home.",
                tagline: "Driven by Precision. Evolved by Design.",
                timeline: [
                    { period: "WEEKS 1–2", task: "Design Development & Final Approval" },
                    { period: "WEEKS 3–6", task: "Material Procurement & Shop Preparation" },
                    { period: "WEEKS 7–12", task: "Custom Fabrication & Finishing" },
                    { period: "WEEKS 13–14", task: "Professional Installation" },
                    { period: "WEEK 15", task: "Final Walkthrough & Warranty Activation" }
                ],
                nextSteps: [ "Select Shaker or Euro style", "Approve proposal & sign agreement", "Submit deposit to secure schedule" ]
            });

            const handleImageUpload = (imageType, event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => setImages(prev => ({ ...prev, [imageType]: e.target.result }));
                    reader.readAsDataURL(file);
                }
            };

            const handleContentChange = (field, value) => setContent(prev => ({ ...prev, [field]: value }));
            const handleTimelineChange = (index, field, value) => setContent(prev => ({ ...prev, timeline: prev.timeline.map((item, i) => i === index ? { ...item, [field]: value } : item) }));
            const handleNextStepChange = (index, value) => setContent(prev => ({ ...prev, nextSteps: prev.nextSteps.map((step, i) => i === index ? value : step) }));
            const addTimelineItem = () => setContent(prev => ({ ...prev, timeline: [...prev.timeline, { period: "NEW PERIOD", task: "New Task" }] }));
            const removeTimelineItem = (index) => setContent(prev => ({ ...prev, timeline: prev.timeline.filter((_, i) => i !== index) }));
            const addNextStep = () => setContent(prev => ({ ...prev, nextSteps: [...prev.nextSteps, "New step"] }));
            const removeNextStep = (index) => setContent(prev => ({ ...prev, nextSteps: prev.nextSteps.filter((_, i) => i !== index) }));

            useEffect(() => {
                const fetchProposals = async () => {
                    const { data, error } = await supabaseClient.from('proposals').select('*');
                    if (error) {
                        console.error('Error fetching proposals:', error);
                        alert("Could not fetch proposals. Make sure your Row Level Security policy is set up correctly in Supabase.");
                    } else {
                        const formattedProposals = data.map(p => ({ name: p.name, savedAt: p.created_at, content: p.content, images: p.images }));
                        setSavedProposals(formattedProposals);
                    }
                };
                fetchProposals();
            }, []);

            useEffect(() => {
                if (currentProposalName) {
                    const autoSaveInterval = setInterval(() => saveProposal(currentProposalName, false), 30000);
                    return () => clearInterval(autoSaveInterval);
                }
            }, [content, images, currentProposalName]);

            const saveProposal = async (name, showAlert = true) => {
                try {
                    const proposalData = { content, images };
                    const { data: existing, error: selectError } = await supabaseClient.from('proposals').select('name').eq('name', name).single();
                    if (selectError && selectError.code !== 'PGRST116') throw selectError;

                    if (existing) {
                        const { error } = await supabaseClient.from('proposals').update(proposalData).eq('name', name);
                        if (error) throw error;
                    } else {
                        const { error } = await supabaseClient.from('proposals').insert([{ name, ...proposalData }]);
                        if (error) throw error;
                    }

                    setCurrentProposalName(name);
                    const { data: updatedProposals } = await supabaseClient.from('proposals').select('*');
                    setSavedProposals(updatedProposals.map(p => ({ name: p.name, savedAt: p.created_at, content: p.content, images: p.images })));
                    
                    if (showAlert) alert('Proposal "' + name + '" saved successfully to the cloud!');
                } catch (error) {
                    console.error('Error saving proposal:', error);
                    alert('Error: Could not save proposal. ' + error.message);
                }
            };

            const loadProposal = (name) => {
                const proposal = savedProposals.find(p => p.name === name);
                if (proposal) {
                    setContent(proposal.content);
                    setImages(proposal.images);
                    setCurrentProposalName(name);
                    alert('Proposal "' + name + '" loaded successfully!');
                }
            };

            const deleteProposal = async (name) => {
                if (confirm('Are you sure you want to delete proposal "' + name + '"? This cannot be undone.')) {
                    try {
                        const { error } = await supabaseClient.from('proposals').delete().eq('name', name);
                        if (error) throw error;
                        setSavedProposals(savedProposals.filter(p => p.name !== name));
                        if (currentProposalName === name) setCurrentProposalName('');
                        alert('Proposal "' + name + '" deleted.');
                    } catch (error) {
                        console.error('Error deleting proposal:', error);
                        alert('Error: Could not delete proposal. ' + error.message);
                    }
                }
            };
            
            const handleSaveClick = () => {
                const name = prompt('Enter a name for this proposal:');
                if (name && name.trim()) saveProposal(name.trim());
            };

            const exportClientHTML = () => {
                let clientHTML = '<!DOCTYPE html>';
                clientHTML += '<html lang="en">';
                clientHTML += '<head>';
                clientHTML += '<meta charset="UTF-8">';
                clientHTML += '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
                clientHTML += '<title>' + content.title + ' - ' + content.clientName + '</title>';
                clientHTML += '<script src="https://cdn.tailwindcss.com">' + '<' + '/script>';
                clientHTML += '<style>';
                clientHTML += '@media print { * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } .print\\:hidden { display: none !important; } .proposal-page { width: 8.5in !important; height: 11in !important; margin: 0 !important; page-break-after: always !important; overflow: hidden !important; } @page { size: 8.5in 11in; margin: 0.25in; } .proposal-container, body { background: white !important; } body { font-size: 12px !important; } }';
                clientHTML += '.proposal-page { display: flex; flex-direction: column; min-height: 800px; box-sizing: border-box; }';
                clientHTML += '.timeline-item { display: flex !important; align-items: flex-start !important; margin-bottom: 1.5rem !important; page-break-inside: avoid !important; }';
                clientHTML += '.content-section { overflow-wrap: break-word; word-wrap: break-word; }';
                clientHTML += '</style>';
                clientHTML += '</head>';
                clientHTML += '<body>';
                clientHTML += '<div class="w-full bg-slate-100 min-h-screen">';
                clientHTML += '<div class="bg-white shadow-sm border-b border-slate-200 print:hidden"><div class="max-w-4xl mx-auto p-4 text-center">';
                clientHTML += '<h1 class="text-2xl font-light text-slate-800 mb-4">' + content.title + '</h1>';
                clientHTML += '<button onclick="window.print()" class="bg-slate-800 text-white px-8 py-3 hover:bg-slate-900 transition-colors font-medium tracking-wide uppercase text-sm shadow-lg">Download PDF</button>';
                clientHTML += '</div></div>';
                clientHTML += '<div class="proposal-container max-w-none mx-auto bg-white">';
                
                // Page 1
                clientHTML += '<div class="proposal-page w-full max-w-4xl mx-auto bg-white shadow-xl mb-8">';
                clientHTML += '<div class="bg-gradient-to-r from-slate-800 to-slate-700 p-8 relative"><div class="absolute bottom-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-amber-400 to-transparent"></div><div class="flex justify-between items-start"><div class="flex items-center space-x-6">';
                clientHTML += (images.logo ? '<img src="' + images.logo + '" alt="Company Logo" class="max-w-40 max-h-16 object-contain filter brightness-0 invert" />' : '<div class="w-40 h-16 bg-white bg-opacity-20 border border-white border-opacity-30 flex items-center justify-center rounded text-white text-xs">LOGO</div>');
                clientHTML += '<div class="h-12 w-px bg-white bg-opacity-30"></div><div class="text-white"><div class="text-2xl font-light tracking-wide">FOUNDRY</div><div class="text-lg font-light tracking-widest text-slate-300">CABINETCO.</div></div></div><div class="text-right text-white text-sm"><div class="font-medium tracking-wide">PROJECT ' + content.projectNumber + '</div><div class="text-slate-300">' + content.date + '</div></div></div></div>';
                clientHTML += '<div class="flex-1 flex flex-col justify-center items-center text-center px-16 py-12"><div class="max-w-4xl"><div class="mb-8"><div class="text-sm font-medium text-slate-600 uppercase tracking-widest mb-4">CUSTOM CABINETRY PROPOSAL</div><h1 class="text-4xl font-light text-slate-800 mb-6 leading-tight tracking-tight">' + content.title.split('–')[0] + '<br/><span class="text-2xl text-slate-600">' + (content.title.split('–')[1] || '') + '</span></h1><div class="w-24 h-px bg-gradient-to-r from-transparent via-amber-400 to-transparent mx-auto"></div></div>';
                clientHTML += '<div class="bg-slate-50 p-8 border-l-4 border-slate-800 text-left shadow-lg"><div class="grid md:grid-cols-2 gap-8 mb-6"><div class="text-center"><div class="text-3xl font-light text-slate-800 mb-2">' + content.totalInvestment + '</div><div class="text-sm text-slate-600 uppercase tracking-wide">Investment</div></div><div class="text-center"><div class="text-3xl font-light text-slate-800 mb-2">' + content.warrantyYears + '</div><div class="text-sm text-slate-600 uppercase tracking-wide">Year Warranty</div></div></div><p class="text-base leading-relaxed text-slate-700 mb-4">' + content.executiveSummary + '</p><p class="text-sm text-slate-600">' + content.warrantyText + '</p></div></div></div>';
                clientHTML += '<div class="bg-slate-800 p-4 mt-auto"><div class="flex items-center justify-center"><div class="text-slate-300 text-sm tracking-widest">' + content.tagline + '</div></div></div>';
                clientHTML += '</div>';
                // ... (The rest of the pages would follow this pattern)
                clientHTML += '</div></div></body></html>';

                const blob = new Blob([clientHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = content.projectNumber + '_' + content.clientName.replace(/\s+/g, '_') + '_Proposal.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('Client HTML file downloaded!');
            };

            return (
                <div className="w-full bg-slate-100 min-h-screen">
                    {/* The rest of the JSX for your app goes here */}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProposalBuilder />);
    </script>
</body>
</html>
