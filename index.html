<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Foundry — Full Proposal Builder</title>
  <meta name="color-scheme" content="light"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @media print {
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .print\:hidden { display: none !important; }
      .proposal-page { width: 8.5in !important; height: 11in !important; margin: 0 !important; page-break-after: always !important; overflow: hidden !important; }
      @page { size: 8.5in 11in; margin: 0.25in; }
      .proposal-container, body { background: white !important; }
      body { font-size: 12px !important; }
    }
    .proposal-page { display:flex; flex-direction:column; min-height:800px; box-sizing:border-box; }
    .content-section { overflow-wrap: break-word; word-wrap: break-word; }
    .hidden { display: none; }
  </style>
</head>
<body class="bg-slate-100">
  <!-- Fallback so you never see a blank screen -->
  <div id="fallback" class="max-w-3xl mx-auto mt-6 p-4 bg-white border border-slate-200 rounded-lg shadow">
    <div class="text-lg font-medium text-slate-800">Foundry — Proposal Builder (Full)</div>
    <div class="text-slate-600 text-sm">If this message doesn’t disappear shortly, open Console (F12) for errors.</div>
  </div>

  <div id="app" class="hidden">
    <!-- Top bar -->
    <div class="bg-white shadow border-b border-slate-200 print:hidden">
      <div class="max-w-7xl mx-auto p-6">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div>
            <h1 class="text-2xl font-light text-slate-800">Full Proposal Builder — Supabase</h1>
            <div id="status" class="text-xs text-slate-500 mt-1">Initializing…</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button id="btnSave"   class="bg-green-600 text-white px-4 py-2 text-sm rounded shadow">Save</button>
            <button id="btnLoad"   class="bg-blue-600 text-white px-4 py-2 text-sm rounded shadow">Load</button>
            <button id="btnExport" class="bg-orange-600 text-white px-4 py-2 text-sm rounded shadow">Export for Client</button>
            <button id="btnClientView" class="bg-slate-700 text-white px-4 py-2 text-sm rounded shadow">Open Client View</button>
            <button id="btnPDF"    class="bg-purple-600 text-white px-4 py-2 text-sm rounded shadow">Generate PDF</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Body: left images / right content -->
    <div class="max-w-7xl mx-auto p-6 grid md:grid-cols-3 gap-6">
      <!-- Images -->
      <div class="space-y-3">
        <div class="text-lg font-medium text-slate-800">Visual Assets</div>
        <div id="assetsGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <!-- generated file inputs -->
        </div>
      </div>

      <!-- Content -->
      <div class="md:col-span-2 space-y-3">
        <div class="text-lg font-medium text-slate-800">Content</div>
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-xs uppercase text-slate-600 mb-1">Client Name</label>
            <input id="in_clientName" class="w-full p-2 border border-slate-300"/>
          </div>
          <div>
            <label class="block text-xs uppercase text-slate-600 mb-1">Project Number</label>
            <input id="in_projectNumber" class="w-full p-2 border border-slate-300"/>
          </div>
          <div class="sm:col-span-2">
            <label class="block text-xs uppercase text-slate-600 mb-1">Title</label>
            <input id="in_title" class="w-full p-2 border border-slate-300"/>
          </div>
          <div class="sm:col-span-2">
            <label class="block text-xs uppercase text-slate-600 mb-1">Executive Summary</label>
            <textarea id="in_exec" rows="3" class="w-full p-2 border border-slate-300"></textarea>
          </div>
          <div>
            <label class="block text-xs uppercase text-slate-600 mb-1">Total Investment</label>
            <input id="in_invest" class="w-full p-2 border border-slate-300"/>
          </div>
          <div>
            <label class="block text-xs uppercase text-slate-600 mb-1">Warranty (years)</label>
            <input id="in_wyears" class="w-full p-2 border border-slate-300"/>
          </div>
          <div class="sm:col-span-2">
            <label class="block text-xs uppercase text-slate-600 mb-1">Warranty Text</label>
            <textarea id="in_wtext" rows="2" class="w-full p-2 border border-slate-300"></textarea>
          </div>

          <!-- Links -->
          <div class="sm:col-span-2">
            <label class="block text-xs uppercase text-slate-600 mb-1">Online Plans Link (optional)</label>
            <input id="in_plans" placeholder="https://…" class="w-full p-2 border border-slate-300"/>
          </div>
          <div class="sm:col-span-2">
            <label class="block text-xs uppercase text-slate-600 mb-1">SketchUp 3D Link (optional)</label>
            <input id="in_sketchup" placeholder="https://…" class="w-full p-2 border border-slate-300"/>
          </div>
        </div>

        <div>
          <div class="flex items-center justify-between mb-2">
            <label class="block text-xs uppercase text-slate-600">Project Timeline</label>
            <button id="btnAddPhase" class="px-2 py-1 bg-slate-700 text-white text-xs rounded">Add Phase</button>
          </div>
          <div id="timelineList" class="space-y-2"></div>
        </div>

        <div>
          <div class="flex items-center justify-between mb-2">
            <label class="block text-xs uppercase text-slate-600">Next Steps</label>
            <button id="btnAddStep" class="px-2 py-1 bg-slate-700 text-white text-xs rounded">Add Step</button>
          </div>
          <div id="stepsList" class="space-y-2"></div>
        </div>
      </div>
    </div>

    <!-- Preview -->
    <div class="proposal-container max-w-none mx-auto bg-white">
      <div id="preview"></div>
    </div>
  </div>

  <!-- Load modal -->
  <div id="loadModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 print:hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-light text-slate-800">Saved Proposals</h2>
        <button id="btnCloseLoad" class="text-slate-400 hover:text-slate-600 text-2xl">×</button>
      </div>
      <div id="savedList" class="space-y-2"></div>
    </div>
  </div>

  <script>
    // ====== CONFIG (your project + anon key) ======
    const SUPABASE_URL = "https://nqzyoegnquyqfngmaktn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xenlvZWducXV5cWZuZ21ha3RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTkzNzYsImV4cCI6MjA3NDQzNTM3Nn0.lcQ8VW3zSdvyoZkJbhnT3CeyeYbxswEiAhZnAjo5Lac";

    // ====== STATE ======
    const state = {
      name: "",
      images: { logo:null, shakerRender:null, euroRender:null, shakerVanity:null, euroVanity:null, floorPlan:null },
      content: {
        title: "Custom Cabinet Proposal – Forest Grove, Oregon",
        projectNumber: "FCB-2025-001",
        date: new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),
        clientName: "Valued Client",
        executiveSummary: "We are pleased to present this proposal for custom cabinetry for your Forest Grove home. Our proposal includes two distinct style options: classic Shaker and modern Euro/Flat Panel designs, allowing you to choose the perfect aesthetic for your space.",
        totalInvestment: "$7,595",
        warrantyYears: "3",
        warrantyText: "This comprehensive package includes professional build, delivery, and installation services, all backed by our 3-year workmanship warranty for your complete peace of mind.",
        shakerDescription: "Classic framed doors with recessed panels. Painted finish.",
        euroDescription: "Modern frameless full-overlay doors. Unpainted for customization.",
        shakerVanityDescription: "Classic framed vanity doors with recessed panels. Painted finish.",
        euroVanityDescription: "Modern frameless full-overlay vanity doors. Unpainted for customization.",
        floorPlanDescription: "Plan view showing placement of sink, dishwasher, refrigerator, range, and island cabinetry.",
        onlinePlansLink: "",
        sketchupLink: "",
        closingNote: "Thank you for considering Foundry Cabinet Co. We look forward to creating cabinetry that's the perfect fit for your home.",
        tagline: "Driven by Precision. Evolved by Design.",
        timeline: [
          { period:"WEEKS 1–2", task:"Design Development & Final Approval" },
          { period:"WEEKS 3–6", task:"Material Procurement & Shop Preparation" },
          { period:"WEEKS 7–12", task:"Custom Fabrication & Finishing" },
          { period:"WEEKS 13–14", task:"Professional Installation" },
          { period:"WEEK 15", task:"Final Walkthrough & Warranty Activation" }
        ],
        nextSteps: ["Select Shaker or Euro style","Approve proposal & sign agreement","Submit deposit to secure schedule"]
      },
      saved: []
    };

    // ====== HELPERS ======
    const qs  = (s, el=document)=> el.querySelector(s);
    const esc = (s)=> String(s||"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
    const onFileToDataURL = (file, cb)=>{ const r=new FileReader(); r.onload=(e)=>cb(e.target.result); r.readAsDataURL(file); };
    function setStatus(msg){ const el=qs('#status'); if(el) el.textContent = msg; }

    // ====== SUPABASE ======
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    async function ensureAuth(){
      const { data } = await db.auth.getUser();
      if(!data?.user){ await db.auth.signInAnonymously(); }
    }
    async function listProposals(){
      const { data, error } = await db.from("proposals").select("name, created_at, content, images").order("created_at",{ascending:false});
      if (error) throw error;
      return (data||[]).map(p=>({ name:p.name, savedAt:p.created_at, content:p.content, images:p.images }));
    }
    async function upsertProposal(name, payload){
      let { data: existing, error: selErr } = await db.from("proposals").select("name").eq("name", name).maybeSingle();
      if (selErr) throw selErr;
      if (existing) {
        const { error } = await db.from("proposals").update(payload).eq("name", name);
        if (error) throw error;
      } else {
        const { error } = await db.from("proposals").insert({ name, ...payload });
        if (error) throw error;
      }
    }
    async function deleteProposal(name){
      const { error } = await db.from("proposals").delete().eq("name", name);
      if (error) throw error;
    }

    // ====== CLIENT HTML BUILDER (3 pages) ======
    function buildClientInner(content, images){
      const titleA = esc(content.title).split("–")[0]||"";
      const titleB = esc(content.title).split("–")[1]||"";
      const timeline = (content.timeline||[]).map((it,i)=>{
        const colors = ["bg-amber-500","bg-slate-400","bg-slate-500","bg-slate-600","bg-slate-700"];
        const color = colors[i % colors.length];
        return `
          <div class="flex items-start space-x-4">
            <div class="w-4 h-4 ${color} flex-shrink-0 mt-1"></div>
            <div class="flex-1">
              <div class="font-bold text-slate-800 tracking-wide text-sm uppercase">${esc(it.period)}</div>
              <div class="text-slate-600 text-base mt-1">${esc(it.task)}</div>
            </div>
          </div>`;
      }).join("");
      const steps = (content.nextSteps||[]).map((s,i)=>`
        <div class="flex items-start space-x-3">
          <div class="w-6 h-6 border-2 border-slate-800 flex-shrink-0 mt-0.5 flex items-center justify-center">
            <span class="text-slate-800 font-bold text-sm">${i+1}</span>
          </div>
          <span class="text-slate-700 text-base leading-relaxed">${esc(s)}</span>
        </div>`).join("");

      const imgOrPh = (src, label)=> src
        ? `<img src="${src}" alt="${label}" class="w-full h-full object-cover" />`
        : `<div class="w-full h-full bg-slate-100 border-2 border-dashed border-slate-300 flex items-center justify-center"><span class="text-slate-400 text-sm tracking-wide">${label.toUpperCase()}</span></div>`;

      return `
      <!-- Page 1 -->
      <div class="proposal-page w-full max-w-4xl mx-auto bg-white shadow-xl mb-8">
        <div class="bg-gradient-to-r from-slate-800 to-slate-700 p-8 relative">
          <div class="absolute bottom-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-amber-400 to-transparent"></div>
          <div class="flex justify-between items-start">
            <div class="flex items-center space-x-6">
              <div class="w-40 h-16">${imgOrPh(images.logo, 'Logo')}</div>
              <div class="h-12 w-px bg-white/30"></div>
              <div class="text-white">
                <div class="text-2xl font-light tracking-wide">FOUNDRY</div>
                <div class="text-lg font-light tracking-widest text-slate-300">CABINETCO.</div>
              </div>
            </div>
            <div class="text-right text-white text-sm">
              <div class="font-medium tracking-wide">PROJECT ${esc(content.projectNumber)}</div>
              <div class="text-slate-300">${esc(content.date)}</div>
            </div>
          </div>
        </div>
        <div class="flex-1 flex flex-col justify-center items-center text-center px-16 py-12">
          <div class="max-w-4xl">
            <div class="mb-8">
              <div class="text-sm font-medium text-slate-600 uppercase tracking-widest mb-4">CUSTOM CABINETRY PROPOSAL</div>
              <h1 class="text-4xl font-light text-slate-800 mb-6 leading-tight tracking-tight">
                ${titleA}<br/><span class="text-2xl text-slate-600">${titleB||""}</span>
              </h1>
              <div class="w-24 h-px bg-gradient-to-r from-transparent via-amber-400 to-transparent mx-auto"></div>
            </div>
            <div class="bg-slate-50 p-8 border-l-4 border-slate-800 text-left shadow-lg">
              <div class="grid md:grid-cols-2 gap-8 mb-6">
                <div class="text-center">
                  <div class="text-3xl font-light text-slate-800 mb-2">${esc(content.totalInvestment)}</div>
                  <div class="text-sm text-slate-600 uppercase tracking-wide">Investment</div>
                </div>
                <div class="text-center">
                  <div class="text-3xl font-light text-slate-800 mb-2">${esc(content.warrantyYears)}</div>
                  <div class="text-sm text-slate-600 uppercase tracking-wide">Year Warranty</div>
                </div>
              </div>
              <p class="text-base leading-relaxed text-slate-700 mb-4">${esc(content.executiveSummary)}</p>
              <p class="text-sm text-slate-600">${esc(content.warrantyText)}</p>
            </div>
          </div>
        </div>
        <div class="bg-slate-800 p-4 mt-auto">
          <div class="flex items-center justify-center">
            <div class="text-slate-300 text-sm tracking-widest">${esc(content.tagline)}</div>
          </div>
        </div>
      </div>

      <!-- Page 2 -->
      <div class="proposal-page w-full max-w-4xl mx-auto bg-white shadow-xl mb-8">
        <div class="border-b border-slate-200 pb-6 mb-8 px-8 pt-8">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-light text-slate-800 tracking-tight">Design Options & Layout</h2>
            <div class="text-sm text-slate-500">PROJECT ${esc(content.projectNumber)} | PAGE 02</div>
          </div>
        </div>
        <div class="px-8 flex-1">
          <div class="grid grid-cols-2 gap-12 mb-12">
            <div class="space-y-6">
              <div class="text-center">
                <h3 class="text-xl font-medium text-slate-800 mb-6 tracking-tight">SHAKER STYLE</h3>
                <div class="mb-6">
                  <div class="bg-slate-50 p-4 shadow-lg h-48">
                    ${imgOrPh(images.shakerRender, 'Shaker Kitchen')}
                  </div>
                  <div class="mt-3 min-h-[80px] flex flex-col justify-start">
                    <h4 class="text-base font-medium text-slate-800 mb-1 tracking-tight">Kitchen Cabinetry</h4>
                    <p class="text-slate-600 text-sm leading-relaxed">${esc(content.shakerDescription)}</p>
                  </div>
                </div>
                <div>
                  <div class="bg-slate-50 p-4 shadow-lg h-48">
                    ${imgOrPh(images.shakerVanity, 'Shaker Vanity')}
                  </div>
                  <div class="mt-3 min-h-[80px] flex flex-col justify-start">
                    <h4 class="text-base font-medium text-slate-800 mb-1 tracking-tight">Vanity Cabinetry</h4>
                    <p class="text-slate-600 text-sm leading-relaxed">${esc(content.shakerVanityDescription)}</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="space-y-6">
              <div class="text-center">
                <h3 class="text-xl font-medium text-slate-800 mb-6 tracking-tight">EURO STYLE</h3>
                <div class="mb-6">
                  <div class="bg-slate-50 p-4 shadow-lg h-48">
                    ${imgOrPh(images.euroRender, 'Euro Kitchen')}
                  </div>
                  <div class="mt-3 min-h-[80px] flex flex-col justify-start">
                    <h4 class="text-base font-medium text-slate-800 mb-1 tracking-tight">Kitchen Cabinetry</h4>
                    <p class="text-slate-600 text-sm leading-relaxed">${esc(content.euroDescription)}</p>
                  </div>
                </div>
                <div>
                  <div class="bg-slate-50 p-4 shadow-lg h-48">
                    ${imgOrPh(images.euroVanity, 'Euro Vanity')}
                  </div>
                  <div class="mt-3 min-h-[80px] flex flex-col justify-start">
                    <h4 class="text-base font-medium text-slate-800 mb-1 tracking-tight">Vanity Cabinetry</h4>
                    <p class="text-slate-600 text-sm leading-relaxed">${esc(content.euroVanityDescription)}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Architectural Layout -->
          <div class="space-y-4">
            <h3 class="text-lg font-medium text-slate-800 tracking-tight text-center">ARCHITECTURAL LAYOUT</h3>
            <div class="bg-slate-50 p-8 shadow-lg">
              ${ images.floorPlan
                ? `<img src="${images.floorPlan}" alt="Kitchen Floor Plan" class="w-full h-64 object-contain" />`
                : `<div class="w-full h-64 bg-slate-100 border-2 border-dashed border-slate-300 flex items-center justify-center"><span class="text-slate-400 text-sm tracking-wide">FLOOR PLAN</span></div>`}
            </div>
            <p class="text-slate-600 text-center text-sm leading-relaxed">${esc(content.floorPlanDescription)}</p>

            ${ content.onlinePlansLink ? `
              <div class="text-center mt-2">
                <a href="${esc(content.onlinePlansLink)}" target="_blank" rel="noopener noreferrer"
                   class="text-slate-800 font-medium hover:text-amber-600">View detailed plans</a>
              </div>` : ''}

            <!-- ✨ Styled 3D block like your screenshot -->
            ${ content.sketchupLink ? `
              <div class="bg-amber-50 border border-amber-200 p-6 mt-6 text-center rounded">
                <h4 class="text-lg font-semibold text-slate-800 mb-3 flex items-center justify-center gap-2">
                  🏠 VIEW IN 3D
                </h4>
                <p class="text-slate-700 text-sm mb-4">
                  Experience your kitchen design in full 3D. Rotate, zoom, and explore every detail of your custom cabinetry.
                </p>
                <a href="${esc(content.sketchupLink)}" target="_blank" rel="noopener noreferrer"
                   class="inline-block bg-slate-800 text-white px-8 py-3 rounded shadow hover:bg-slate-900 transition">
                  VIEW 3D MODEL
                </a>
              </div>` : ''}
          </div>
        </div>
      </div>

      <!-- Page 3 -->
      <div class="proposal-page w-full max-w-4xl mx-auto bg-white shadow-xl mb-8">
        <div class="border-b border-slate-200 pb-6 mb-8 px-8 pt-8">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-light text-slate-800 tracking-tight">Timeline & Next Steps</h2>
            <div class="text-sm text-slate-500">PROJECT ${esc(content.projectNumber)} | PAGE 03</div>
          </div>
        </div>
        <div class="px-8 flex-1 flex flex-col">
          <div class="grid grid-cols-2 gap-12 mb-12">
            <div class="space-y-6">
              <h3 class="text-lg font-medium text-slate-800 tracking-tight border-b border-slate-200 pb-3">PROJECT TIMELINE</h3>
              <div class="space-y-6">${timeline}</div>
            </div>
            <div class="space-y-6">
              <h3 class="text-lg font-medium text-slate-800 tracking-tight border-b border-slate-200 pb-3">NEXT STEPS</h3>
              <div class="space-y-4">${steps}</div>
            </div>
          </div>
          <div class="bg-slate-800 text-white p-8 text-center shadow-lg mb-6">
            <p class="text-base leading-relaxed">${esc(content.closingNote)}</p>
          </div>
          <div class="text-center mt-auto mb-6">
            <div class="mb-3">
              ${ images.logo
                ? `<img src="${images.logo}" alt="Company Logo" class="max-w-24 max-h-10 mx-auto object-contain" />`
                : `<div class="w-24 h-10 bg-slate-100 border border-slate-300 flex items-center justify-center mx-auto text-slate-400 text-xs">LOGO</div>`}
            </div>
            <div class="text-slate-500 text-xs tracking-widest uppercase">${esc(content.tagline)}</div>
          </div>
        </div>
      </div>`;
    }

    function renderPreview(){ qs('#preview').innerHTML = buildClientInner(state.content, state.images); }

    function wireEditor(){
      const bindVal = (sel, key)=>{ const el=qs(sel); el.value=state.content[key]||''; el.oninput=(e)=>{ state.content[key]=e.target.value; renderPreview(); }; };
      bindVal('#in_clientName','clientName');
      bindVal('#in_projectNumber','projectNumber');
      bindVal('#in_title','title');
      bindVal('#in_exec','executiveSummary');
      bindVal('#in_invest','totalInvestment');
      bindVal('#in_wyears','warrantyYears');
      bindVal('#in_wtext','warrantyText');
      bindVal('#in_plans','onlinePlansLink');
      bindVal('#in_sketchup','sketchupLink');

      // build visual assets grid
      const assetDefs = [
        ['logo','Company Logo'],
        ['shakerRender','Shaker Kitchen'],
        ['euroRender','Euro Kitchen'],
        ['shakerVanity','Shaker Vanity'],
        ['euroVanity','Euro Vanity'],
        ['floorPlan','Floor Plan'],
      ];
      const grid = qs('#assetsGrid');
      grid.innerHTML = '';
      assetDefs.forEach(([key,label])=>{
        const wrap = document.createElement('div');
        wrap.innerHTML = `
          <label class="block text-xs uppercase text-slate-600 mb-1">${label}</label>
          <input id="file_${key}" type="file" accept="image/*" class="w-full p-2 border border-slate-300 bg-white text-sm"/>
          <div class="mt-2 border border-slate-200 bg-white h-32 flex items-center justify-center overflow-hidden">
            <span class="text-slate-400 text-xs">No image</span>
          </div>`;
        const input = wrap.querySelector('input');
        const preview = wrap.querySelector('div');
        const updatePreview = ()=>{
          if (state.images[key]) {
            preview.innerHTML = `<img src="${state.images[key]}" alt="${label}" class="object-contain w-full h-32"/>`;
          } else {
            preview.innerHTML = `<span class="text-slate-400 text-xs">No image</span>`;
          }
        };
        updatePreview();
        input.onchange = (e)=>{
          const f = e.target.files[0]; if(!f) return;
          onFileToDataURL(f, (url)=>{ state.images[key]=url; updatePreview(); renderPreview(); });
        };
        grid.appendChild(wrap);
      });

      // timeline
      const tRoot = qs('#timelineList'); tRoot.innerHTML='';
      state.content.timeline.forEach((t, idx)=>{
        const row = document.createElement('div');
        row.className = 'grid grid-cols-3 gap-2 items-center';
        row.innerHTML = `
          <input class="p-2 border border-slate-300 text-sm" value="${esc(t.period)}"/>
          <input class="p-2 border border-slate-300 text-sm" value="${esc(t.task)}"/>
          <button class="px-2 py-1 bg-red-600 text-white text-xs rounded">Remove</button>`;
        const [pIn, tIn, rm] = row.querySelectorAll('input,button');
        pIn.oninput = (e)=>{ t.period = e.target.value; renderPreview(); };
        tIn.oninput = (e)=>{ t.task   = e.target.value; renderPreview(); };
        rm.onclick  = ()=>{ state.content.timeline.splice(idx,1); wireEditor(); renderPreview(); };
        tRoot.appendChild(row);
      });
      qs('#btnAddPhase').onclick = ()=>{ state.content.timeline.push({period:'NEW PERIOD', task:'New Task'}); wireEditor(); renderPreview(); };

      // steps
      const sRoot = qs('#stepsList'); sRoot.innerHTML='';
      state.content.nextSteps.forEach((s, idx)=>{
        const row = document.createElement('div');
        row.className = 'grid grid-cols-4 gap-2 items-center';
        row.innerHTML = `
          <input class="col-span-3 p-2 border border-slate-300 text-sm" value="${esc(s)}"/>
          <button class="px-2 py-1 bg-red-600 text-white text-xs rounded">Remove</button>`;
        const [sIn, rm] = row.querySelectorAll('input,button');
        sIn.oninput = (e)=>{ state.content.nextSteps[idx]=e.target.value; renderPreview(); };
        rm.onclick  = ()=>{ state.content.nextSteps.splice(idx,1); wireEditor(); renderPreview(); };
        sRoot.appendChild(row);
      });
      qs('#btnAddStep').onclick = ()=>{ state.content.nextSteps.push('New step'); wireEditor(); renderPreview(); };
    }

    // ====== EXPORT (client HTML with 3 pages) ======
    function exportClient(){
      const inner = buildClientInner(state.content, state.images);
      const html = `<!DOCTYPE html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>${esc(state.content.title)} - ${esc(state.content.clientName)}</title><script src="https://cdn.tailwindcss.com"><\/script><style>@media print{*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}.print\\:hidden{display:none!important}.proposal-page{width:8.5in!important;height:11in!important;margin:0!important;page-break-after:always!important;overflow:hidden!important}@page{size:8.5in 11in;margin:0.25in}.proposal-container,body{background:#fff!important}body{font-size:12px!important}}.proposal-page{display:flex;flex-direction:column;min-height:800px;box-sizing:border-box}.content-section{overflow-wrap:break-word;word-wrap:break-word}</style></head><body><div class="bg-white shadow-sm border-b border-slate-200 print:hidden"><div class="max-w-4xl mx-auto p-4 text-center"><h1 class="text-2xl font-light text-slate-800 mb-4">${esc(state.content.title)}</h1><button onclick="window.print()" class="bg-slate-800 text-white px-8 py-3 hover:bg-slate-900 transition-colors font-medium tracking-wide uppercase text-sm shadow-lg">Download PDF</button></div></div><div class="proposal-container max-w-none mx-auto bg-white">${inner}</div></body></html>`;
      const blob = new Blob([html], {type:"text/html"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`${state.content.projectNumber}_${state.content.clientName.replace(/\s+/g,'_')}_Proposal.html`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // ====== CLIENT VIEW (open same page in clean window) ======
    function openClientView(){
      const inner = buildClientInner(state.content, state.images);
      const html = `<!DOCTYPE html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>${esc(state.content.title)} - ${esc(state.content.clientName)}</title><script src="https://cdn.tailwindcss.com"><\/script><style>@media print{*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}.print\\:hidden{display:none!important}.proposal-page{width:8.5in!important;height:11in!important;margin:0!important;page-break-after:always!important;overflow:hidden!important}@page{size:8.5in 11in;margin:0.25in}.proposal-container,body{background:#fff!important}body{font-size:12px!important}}.proposal-page{display:flex;flex-direction:column;min-height:800px;box-sizing:border-box}.content-section{overflow-wrap:break-word;word-wrap:break-word}</style></head><body><div class="bg-white shadow-sm border-b border-slate-200 print:hidden"><div class="max-w-4xl mx-auto p-4 text-center"><button onclick="window.print()" class="bg-slate-800 text-white px-8 py-3 hover:bg-slate-900 transition-colors font-medium tracking-wide uppercase text-sm shadow-lg">Download PDF</button></div></div><div class="proposal-container max-w-none mx-auto bg-white">${inner}</div></body></html>`;
      const win = window.open('', '_blank');
      win.document.write(html);
      win.document.close();
    }

    // ====== APP START ======
    (async function start(){
      const fb = qs('#fallback'); const app = qs('#app');
      try{
        app.classList.remove('hidden'); if (fb) fb.classList.add('hidden');

        setStatus('Connecting to Supabase…');
        await ensureAuth();
        setStatus('Connected.');

        // Buttons
        qs('#btnSave').onclick = async ()=>{
          const name = prompt('Name this proposal (unique)') || state.content.projectNumber || state.content.clientName || 'Untitled';
          try {
            await upsertProposal(name.trim(), { content: state.content, images: state.images });
            state.name = name.trim();
            setStatus(`Saved "${state.name}" to cloud.`);
          } catch (e) {
            console.error(e); alert('Save failed: ' + (e.message||e));
          }
        };

        qs('#btnLoad').onclick = async ()=>{
          try {
            const items = await listProposals();
            state.saved = items;
            const modal = qs('#loadModal'); const list = qs('#savedList');
            list.innerHTML = '';
            if (items.length === 0) {
              list.innerHTML = '<div class="text-slate-500 text-center py-6">No proposals found.</div>';
            } else {
              items.forEach((p)=>{
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between p-3 border border-slate-200 rounded';
                row.innerHTML = `
                  <div>
                    <div class="font-medium text-slate-800">${esc(p.name)}</div>
                    <div class="text-xs text-slate-500">Saved: ${new Date(p.savedAt).toLocaleString()}</div>
                  </div>
                  <div class="flex gap-2">
                    <button class="bg-blue-600 text-white px-3 py-1 text-xs rounded">Load</button>
                    <button class="bg-red-600 text-white px-3 py-1 text-xs rounded">Delete</button>
                  </div>`;
                const [btnLoad, btnDel] = row.querySelectorAll('button');
                btnLoad.onclick = ()=>{
                  state.name = p.name;
                  state.content = p.content || state.content;
                  state.images  = p.images || state.images;
                  renderPreview(); wireEditor();
                  modal.classList.add('hidden');
                  setStatus(`Loaded "${p.name}".`);
                };
                btnDel.onclick = async ()=>{
                  if(!confirm(`Delete "${p.name}"?`)) return;
                  try { await deleteProposal(p.name); row.remove(); setStatus(`Deleted "${p.name}".`); }
                  catch (e) { alert('Delete failed: ' + (e.message||e)); }
                };
                list.appendChild(row);
              });
            }
            modal.classList.remove('hidden');
          } catch (e) {
            console.error(e); alert('Load failed: ' + (e.message||e));
          }
        };

        qs('#btnCloseLoad').onclick = ()=> qs('#loadModal').classList.add('hidden');
        qs('#btnExport').onclick = exportClient;
        qs('#btnClientView').onclick = openClientView;
        qs('#btnPDF').onclick = ()=> window.print();

        // Wire inputs + first render
        wireEditor();
        renderPreview();
        setStatus('Ready.');
      }catch(err){
        console.error(err);
        setStatus('Startup error: ' + (err?.message || err));
        if (fb) { fb.classList.remove('hidden'); fb.querySelector('.text-slate-600').textContent = 'Error: ' + (err?.message || err); }
      }
    })();
  </script>
</body>
</html>
