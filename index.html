<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Foundry Cabinet · Co — Proposal Builder</title>

  <!-- Favicon (inline, never 404s) -->
  <link rel="icon"
        href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="%230b1120"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="36" fill="white">F</text></svg>'/>

  <!-- Don’t cache the app shell -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- React + Babel (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind + Supabase -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { --header:#1e293b; --footer:#0b1120; }
    body { background:#f1f5f9; color:#111827; }
    .proposal-page { display:flex; flex-direction:column; min-height:800px; box-sizing:border-box; }
    .card { box-shadow: 0 6px 20px rgba(2,6,23,.08); }
    .logo-clean { display:block; max-height:160px; object-fit:contain; }

    /* bigger preview frames */
    .img-frame { height: 21rem; }
    .img-frame-sm { height: 18rem; }
    .img-frame-layout { height: 26rem; }

    @media print {
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .print\:hidden { display: none !important; }
      .proposal-page { 
        width: 8.5in !important; 
        height: 11in !important; 
        margin: 0 !important; 
        page-break-after: always !important; 
        overflow: visible !important;
        box-sizing: border-box !important;
      }
      @page { size: 8.5in 11in; margin: 0.5in; }
      .two { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 20px !important; }
      .cols { display: grid !important; grid-template-columns: 1.1fr 0.9fr !important; gap: 20px !important; }
      
      /* Improved page break handling */
      .imgBox, .layoutImg, .tlItem, .nxItem { 
        break-inside: avoid !important; 
        page-break-inside: avoid !important;
        margin-bottom: 10px !important;
      }
      
      /* Standardized image handling for print */
      img { 
        break-inside: avoid !important; 
        page-break-inside: avoid !important;
        max-width: 100% !important;
        height: auto !important;
        display: block !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      /* Specific image container sizing for print */
      .img-frame, .img-frame-sm, .img-frame-layout {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        overflow: visible !important;
        height: auto !important;
        min-height: 200px !important;
        max-height: 400px !important;
      }
      
      /* Logo and footer logo sizing */
      .logo, .logo-clean, .footLogo {
        max-height: 120px !important;
        width: auto !important;
        object-fit: contain !important;
      }
      
      /* Image boxes for consistent sizing */
      .imgBox {
        height: auto !important;
        min-height: 200px !important;
        max-height: 300px !important;
        padding: 10px !important;
      }
      
      .imgBox img {
        object-fit: contain !important;
        max-height: 280px !important;
      }
      
      .layoutImg {
        height: auto !important;
        min-height: 250px !important;
        max-height: 400px !important;
        padding: 10px !important;
      }
      
      .layoutImg img {
        object-fit: contain !important;
        max-height: 380px !important;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createClient } = supabase;

    // ---------- CONFIG ----------
    // Inline fallback logo so header/footer never break
    const INLINE_FALLBACK_LOGO =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="800" height="200" viewBox="0 0 800 200">
        <rect fill="none" width="800" height="200"/>
        <g fill="#ffffff" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial">
          <text x="50%" y="46%" text-anchor="middle" font-size="56" font-weight="700">FOUNDRY</text>
          <text x="50%" y="70%" text-anchor="middle" font-size="28" letter-spacing="4">CABINET · CO</text>
        </g>
      </svg>`);

    // ✅ point this to your repo logo. If it lives in /assets/, switch to the commented line below.
    const DEFAULT_LOGO_PATH = new URL('./Foundry-Cabinetco-Logo-2-White-Text.png', window.location.href).toString();
    // const DEFAULT_LOGO_PATH = new URL('./assets/Foundry-Cabinetco-Logo-2-White-Text.png', window.location.href).toString();

    const SUPABASE_URL = "https://nqzyoegnquyqfngmaktn.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xenlvZWducXV5cWZuZ21ha3RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTkzNzYsImV4cCI6MjA3NDQzNTM3Nn0.lcQ8VW3zSdvyoZkJbhnT3CeyeYbxswEiAhZnAjo5Lac";
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // ----------------------------

    // ---------- UI bits ----------
    const Label = ({children}) => <label className="text-xs font-medium text-slate-600 uppercase tracking-wide">{children}</label>;
    const Input = (props) => <input {...props} className={"w-full border rounded px-3 py-2 text-sm bg-white "+(props.className||"")} />;
    const TextArea = (props) => <textarea {...props} className={"w-full border rounded px-3 py-2 text-sm bg-white min-h-[84px] "+(props.className||"")} />;

    // ---------- helpers ----------
    const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));
    const waitForImagesToLoad = async (root=document) => {
      const imgs = Array.from(root.querySelectorAll('img'))
        .filter(img => !img.complete || img.naturalWidth === 0);
      if (imgs.length === 0) return;
      
      // Wait for all images with timeout
      const promises = imgs.map(img => new Promise((resolve) => {
        const timeout = setTimeout(() => {
          console.warn('Image load timeout:', img.src);
          resolve();
        }, 5000); // 5 second timeout per image
        
        const done = () => {
          clearTimeout(timeout);
          resolve();
        };
        
        if (img.complete && img.naturalWidth > 0) {
          done();
        } else {
          img.onload = done;
          img.onerror = done;
        }
      }));
      
      await Promise.all(promises);
    };
    const hasAnyImage = (imgs) => !!(imgs && (imgs.logo || imgs.shakerRender || imgs.euroRender || imgs.shakerVanity || imgs.euroVanity || imgs.floorPlan));

    // Turn URL/file into data URL so export & PDF are self-contained
    const toDataURL = async (src, retries = 2) => {
      try {
        if (!src) return "";
        if (src.startsWith("data:")) return src;
        
        const url = new URL(src, window.location.href);
        url.searchParams.set("_v", Date.now().toString()); // cache-bust
        
        const res = await fetch(url.toString(), { 
          cache: "no-store", 
          mode: "cors",
          headers: {
            'Accept': 'image/*,*/*;q=0.8'
          }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const blob = await res.blob();
        
        // Verify it's actually an image
        if (!blob.type.startsWith('image/')) {
          console.warn('Non-image content type:', blob.type, 'for', src);
        }
        
        const reader = new FileReader();
        const p = new Promise((resolve, reject) => { 
          reader.onloadend = () => resolve(reader.result || "");
          reader.onerror = () => reject(new Error('FileReader error'));
        });
        reader.readAsDataURL(blob);
        return await p;
      } catch (error) {
        console.warn('toDataURL failed for', src, ':', error.message);
        
        // Retry logic
        if (retries > 0) {
          console.log('Retrying toDataURL for', src, 'retries left:', retries);
          await sleep(100 * (3 - retries)); // Progressive delay
          return toDataURL(src, retries - 1);
        }
        
        // Final fallback - return original src for on-page display
        return src;
      }
    };

    const embedAllImagesInState = async (images, setImages, fallbackLogo) => {
      console.log('Starting image embedding process...');
      
      const [logo, sh, eu, sv, ev, fp] = await Promise.all([
        toDataURL(images.logo || fallbackLogo),
        toDataURL(images.shakerRender),
        toDataURL(images.euroRender),
        toDataURL(images.shakerVanity),
        toDataURL(images.euroVanity),
        toDataURL(images.floorPlan),
      ]);
      
      const newImages = {
        logo: logo || images.logo,
        shakerRender: sh || images.shakerRender,
        euroRender: eu || images.euroRender,
        shakerVanity: sv || images.shakerVanity,
        euroVanity: ev || images.euroVanity,
        floorPlan: fp || images.floorPlan,
      };
      
      console.log('Image embedding results:', {
        logo: logo ? 'embedded' : 'unchanged',
        shakerRender: sh ? 'embedded' : 'unchanged',
        euroRender: eu ? 'embedded' : 'unchanged',
        shakerVanity: sv ? 'embedded' : 'unchanged',
        euroVanity: ev ? 'embedded' : 'unchanged',
        floorPlan: fp ? 'embedded' : 'unchanged',
      });
      
      setImages((prev) => ({
        ...prev,
        ...newImages
      }));
      
      return newImages;
    };

    // ---------- localStorage fallback (if Supabase blocked) ----------
    const LS_LAST = "proposal:lastSaved";                 // {name, content, images, savedAt}
    const LS_BY_NAME = (n) => `proposal:${n}`;

    function App() {
      const urlParams = new URLSearchParams(window.location.search);
      const isClient = urlParams.get("client") === "true";
      const clientId = urlParams.get("id") || "";

      const [netDown, setNetDown] = useState(false);
      const [savedProposals, setSavedProposals] = useState([]);
      const [currentName, setCurrentName] = useState("");

      const [images, setImages] = useState({
        logo: DEFAULT_LOGO_PATH,
        shakerRender: null, euroRender: null,
        shakerVanity: null, euroVanity: null, floorPlan: null
      });

      const [content, setContent] = useState({
        title: "Custom Cabinet Proposal – Forest Grove, Oregon",
        projectNumber: "FCB-2025-001",
        date: new Date().toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' }),
        clientName: "Valued Client",
        executiveSummary: "We are pleased to present this proposal for custom cabinetry for your Forest Grove home. Two distinct style options: classic Shaker and modern Euro/Flat Panel.",
        totalInvestment: "$7,595",
        warrantyYears: "3",
        warrantyText: "Professional build, delivery, installation, backed by a 3-year workmanship warranty.",
        shakerDescription: "Classic framed doors with recessed panels. Painted finish.",
        euroDescription: "Modern frameless full-overlay doors. Natural finish or your chosen color.",
        shakerVanityDescription: "Classic framed vanity doors with recessed panels. Painted finish.",
        euroVanityDescription: "Modern frameless full-overlay vanity doors. Natural finish or your chosen color.",
        floorPlanDescription: "Plan view showing placement and dimensions.",
        closingNote: "Thank you for considering Foundry Cabinet Co. We look forward to creating cabinetry that's the perfect fit for your home.",
        tagline: "Driven by Precision. Evolved by Design.",
        address: "866 N Columbia Blvd, Suite B-110, Portland, OR 97217",
        timeline: [
          { period:"WEEKS 1–2", task:"Design Development & Final Approval" },
          { period:"WEEKS 3–6", task:"Material Procurement & Shop Preparation" },
          { period:"WEEKS 7–12", task:"Custom Fabrication & Finishing" },
          { period:"WEEKS 13–14", task:"Professional Installation" },
          { period:"WEEK 15", task:"Final Walkthrough & Warranty Activation" }
        ],
        nextSteps: ["Select Shaker or Euro style","Approve proposal & sign agreement","Submit deposit to secure schedule"],
        onlinePlansLink: "",
        sketchupLink: ""
      });

      // Load list (cloud)
      useEffect(() => { (async () => {
        try {
          const { data, error } = await db.from('proposals').select('*');
          if (error) throw error;
          setSavedProposals((data || []).map(p => ({ name:p.name, savedAt:p.created_at, content:p.content, images:p.images })));
          setNetDown(false);
        } catch (e) {
          console.warn('fetch proposals failed:', e?.message || e);
          setSavedProposals([]);
          setNetDown(true);
        }
      })() }, []);

      // Auto-save while editing a named proposal
      useEffect(() => {
        if (!currentName) return;
        const id = setInterval(() => save(currentName, false), 30000);
        return () => clearInterval(id);
      }, [content, images, currentName]);

      // On first load: embed any path-based images so Print/PDF works even before uploads
      useEffect(() => { (async () => { await embedAllImagesInState(images, setImages, DEFAULT_LOGO_PATH); })() }, []);

      // Client View: pick ?id, else newest with images, else newest, else localStorage
      useEffect(() => {
        if (!isClient) return;
        (async () => {
          try {
            let targetName = clientId;

            const { data, error } = await db.from("proposals").select("name, content, images, created_at");
            if (error) throw error;

            const rows = (data || []).map(r => ({
              name: r.name,
              row: r,
              savedAt: r?.content?.__savedAt ? Date.parse(r.content.__savedAt) : Date.parse(r.created_at || 0),
              hasImages: hasAnyImage(r.images)
            })).sort((a,b) => b.savedAt - a.savedAt);

            let picked =
              (targetName && rows.find(x => x.name === targetName)) ||
              rows.find(x => x.hasImages) ||
              rows[0];

            if (picked) {
              const chosen = picked.row;
              setContent(chosen.content || content);
              setImages(chosen.images || images);
              await embedAllImagesInState(chosen.images || images, setImages, DEFAULT_LOGO_PATH);
              setNetDown(false);
              return;
            }

            // fallback to localStorage if DB empty
            const local = JSON.parse(localStorage.getItem(LS_LAST) || "null");
            if (local && local.content) {
              setContent(local.content);
              setImages(local.images || images);
              await embedAllImagesInState(local.images || images, setImages, DEFAULT_LOGO_PATH);
            }
          } catch (err) {
            console.warn("Client auto-load failed:", err?.message);
            setNetDown(true);
            // localStorage fallback on error
            const key = clientId ? LS_BY_NAME(clientId) : LS_LAST;
            const local = JSON.parse(localStorage.getItem(key) || localStorage.getItem(LS_LAST) || "null");
            if (local && local.content) {
              setContent(local.content);
              setImages(local.images || images);
              await embedAllImagesInState(local.images || images, setImages, DEFAULT_LOGO_PATH);
            }
          }
        })();
      }, [isClient, clientId]);

      // uploads -> data URLs (perfect for embedding)
      const onImgUpload = (key, file) => {
        const r = new FileReader();
        r.onload = e => setImages(prev => ({ ...prev, [key]: e.target.result }));
        r.readAsDataURL(file);
      };

      const setField = (k, v) => setContent(prev => ({ ...prev, [k]: v }));

      // save (cloud + local fallback)
      const save = async (name, alertOK=true) => {
        const stamp = new Date().toISOString();
        const payload = {
          content: { ...content, __savedAt: stamp },
          images:  { ...images,  __savedAt: stamp }
        };

        // always persist locally as backup
        localStorage.setItem(LS_LAST, JSON.stringify({ name, ...payload, savedAt: stamp }));
        localStorage.setItem(LS_BY_NAME(name), JSON.stringify({ name, ...payload, savedAt: stamp }));

        try {
          const { data:existing, error:existErr } = await db.from('proposals').select('name').eq('name', name).maybeSingle();
          if (existErr && existErr.code !== 'PGRST116') throw existErr;

          if (existing) {
            const { error } = await db.from('proposals').update(payload).eq('name', name);
            if (error) throw error;
          } else {
            const { error } = await db.from('proposals').insert([{ name, ...payload }]);
            if (error) throw error;
          }

          setCurrentName(name);
          const { data: rows, error: listErr } = await db.from('proposals').select('*');
          if (!listErr) setSavedProposals((rows || []).map(p => ({ name:p.name, savedAt:p.created_at, content:p.content, images:p.images })));
          setNetDown(false);
          if (alertOK) alert(`Saved "${name}" to cloud.`);
        } catch (e) {
          setNetDown(true);
          if (alertOK) alert("Save failed: " + (e?.message || e));
        }
      };

      const loadOne = (name) => {
        const p = savedProposals.find(x => x.name === name);
        if (!p) return alert("Not found.");
        setContent(p.content);
        setImages(p.images || images);
        setCurrentName(name);
        alert('Loaded "' + name + '".');
      };

      const deleteOne = async (name) => {
        if (!confirm('Delete "'+name+'"?')) return;
        try {
          const { error } = await db.from('proposals').delete().eq('name', name);
          if (error) throw error;
          setSavedProposals(prev => prev.filter(p => p.name !== name));
          if (currentName === name) setCurrentName("");
          alert('Deleted "' + name + '".');
        } catch (e) {
          alert("Delete failed (cloud). Removed local copy only.");
        }
        localStorage.removeItem(LS_BY_NAME(name));
        const last = JSON.parse(localStorage.getItem(LS_LAST) || "null");
        if (last?.name === name) localStorage.removeItem(LS_LAST);
      };

      // Print: re-embed + wait -> print
      const handlePrint = async () => {
        console.log('Starting print process...');
        
        // Force re-embedding of all images as data URLs
        const embeddedImages = await embedAllImagesInState(images, setImages, DEFAULT_LOGO_PATH);
        
        // Give more time for state updates and re-rendering
        await sleep(500);
        
        // Verify images are embedded as data URLs
        const verifyEmbedding = () => {
          const imageElements = document.querySelectorAll('img');
          let allEmbedded = true;
          imageElements.forEach(img => {
            if (img.src && !img.src.startsWith('data:') && !img.src.includes('svg+xml')) {
              console.warn('Image not embedded:', img.src);
              allEmbedded = false;
            }
          });
          return allEmbedded;
        };
        
        // Wait for all images to fully load
        await waitForImagesToLoad(document);
        
        // Additional verification and wait
        if (!verifyEmbedding()) {
          console.log('Some images not embedded, waiting longer...');
          await sleep(1000);
        }
        
        // Final wait to ensure everything is ready
        await sleep(200);
        
        console.log('Print process ready, opening print dialog...');
        window.print();
      };

      // Export HTML: embed snapshot of CURRENT UI (offline-safe)
      const exportClientHTML = async () => {
        await new Promise(requestAnimationFrame); // flush state
        const c = { ...content };

        const embedded = {
          logo: await toDataURL(images.logo || DEFAULT_LOGO_PATH),
          shakerRender: await toDataURL(images.shakerRender),
          euroRender: await toDataURL(images.euroRender),
          shakerVanity: await toDataURL(images.shakerVanity),
          euroVanity: await toDataURL(images.euroVanity),
          floorPlan: await toDataURL(images.floorPlan),
        };

        const esc = (s) => (s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const has = (v) => v && ("" + v).trim().length > 0;

        const css =
          "body{margin:0;background:#f6f8fb;color:#0f172a;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}"+
          ".wrap{max-width:900px;margin:0 auto}.shadow{box-shadow:0 6px 20px rgba(2,6,23,.08)}"+
          ".page{background:#fff;margin:28px auto;border-radius:6px;overflow:visible;page-break-after:always}"+
          ".bar{display:flex;justify-content:space-between;align-items:flex-start;padding:24px 28px;background:#1e293b}"+
          ".logo{max-height:160px;object-fit:contain;width:auto;display:block}.hdrR{color:#fff;font-size:14px;text-align:right}.muted{color:#cbd5e1}"+
          ".sec{padding:36px}.tac{text-align:center}.small{font-size:14px;color:#475569;letter-spacing:.08em}"+
          ".h1{font-size:34px;font-weight:300;margin:12px 0 18px}.grad{width:96px;height:2px;margin:0 auto 20px;background:linear-gradient(90deg,transparent,#f59e0b,transparent)}"+
          ".panel{background:#f8fafc;border-left:4px solid #1f2937;padding:22px;border-radius:6px}"+
          ".grid{display:grid;grid-template-columns:1fr 1fr;gap:22px;margin-bottom:16px}"+
          ".kpi{background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:14px;text-align:center}.kbig{font-size:26px;margin-bottom:6px}.ksub{font-size:12px;color:#64748b;letter-spacing:.12em}"+
          ".footer{background:#0b1120;color:#e2e8f0;text-align:center;padding:36px 16px;margin-top:28px}"+
          ".footLogo{max-height:90px;object-fit:contain;margin:0 auto 10px;display:block}.footAddr{color:#94a3b8;font-size:14px}.footThanks{color:#cbd5e1;font-size:14px;margin-top:12px}"+
          ".secTitle{font-size:22px;font-weight:300;color:#0f172a;margin:0;padding:26px 28px;border-bottom:1px solid #e5e7eb}"+
          ".secBody{padding:28px}"+
          ".two{display:grid;grid-template-columns:1fr 1fr;gap:28px}"+
          ".imgBox{background:#f8fafc;border:1px solid #e5e7eb;border-radius:6px;display:flex;align-items:center;justify-content:center;height:360px;overflow:hidden;break-inside:avoid;page-break-inside:avoid;padding:10px;box-sizing:border-box}"+
          ".imgBox img{width:auto;height:auto;object-fit:contain;display:block;max-width:100%;max-height:100%}"+
          ".cap{font-size:13px;color:#64748b;margin-top:8px}"+
          ".layoutImg{background:#f8fafc;border:1px solid #e5e7eb;border-radius:6px;display:flex;align-items:center;justify-content:center;height:480px;overflow:hidden;break-inside:avoid;page-break-inside:avoid;padding:10px;box-sizing:border-box}"+
          ".layoutImg img{width:auto;height:auto;object-fit:contain;display:block;max-width:100%;max-height:100%}"+
          ".btn3d{display:inline-block;background:#1f2937;color:#fff;padding:10px 16px;border-radius:6px;text-decoration:none}"+
          ".cols{display:grid;grid-template-columns:1.1fr 0.9fr;gap:28px}"+
          ".tlItem{display:flex;gap:10px;margin-bottom:12px;align-items:flex-start;break-inside:avoid;page-break-inside:avoid}"+
          ".dot{width:12px;height:12px;border-radius:2px;margin-top:4px}"+
          ".tlP{font:700 12px system-ui;letter-spacing:.06em;color:#0f172a;text-transform:uppercase}"+
          ".tlT{color:#475569;margin-top:2px}"+
          ".nxItem{display:flex;gap:10px;margin-bottom:10px;align-items:flex-start;break-inside:avoid;page-break-inside:avoid}"+
          ".num{width:26px;height:26px;border:2px solid #0f172a;display:flex;align-items:center;justify-content:center;font-weight:700;border-radius:4px}"+
          "@page{size:8.5in 11in;margin:0.5in}"+
          "@media print{*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}"+
          "img{break-inside:avoid!important;page-break-inside:avoid!important;max-width:100%!important;height:auto!important;display:block!important;-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}"+
          ".logo,.footLogo{max-height:120px!important;width:auto!important;object-fit:contain!important}"+
          ".imgBox,.layoutImg{display:flex!important;align-items:center!important;justify-content:center!important;overflow:visible!important;height:auto!important;min-height:200px!important;padding:10px!important}"+
          ".imgBox img,.layoutImg img{object-fit:contain!important;max-height:280px!important}"+
          ".layoutImg img{max-height:380px!important}"+
          ".imgBox,.layoutImg,.tlItem,.nxItem{break-inside:avoid!important;page-break-inside:avoid!important;margin-bottom:10px!important}}";

        const blockImg = (src, alt) =>
          src ? "<div class='imgBox'><img src='"+src+"'></div>"
              : "<div class='imgBox' style='color:#94a3b8;font-size:13px'>"+esc(alt)+"</div>";
        const blockImgTall = (src) =>
          src ? "<div class='layoutImg'><img src='"+src+"'></div>"
              : "<div class='layoutImg' style='color:#94a3b8;font-size:13px'>Floor Plan</div>";
        const tlColor = (i) => ["#f59e0b","#64748b","#475569","#334155","#1e293b"][i%5];

        let html = "<!DOCTYPE html><html lang='en'><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width,initial-scale=1'>"+
          "<title>"+esc(c.title)+" - "+esc(c.clientName||"Client")+"</title><style>"+css+"</style></head><body>";

        // PAGE 1
        html += "<div class='wrap page shadow'><div class='bar'>"+
          "<img src='"+(embedded.logo || "")+"' alt='' class='logo'>"+
          "<div class='hdrR'><div>PROJECT "+esc(c.projectNumber)+"</div><div class='muted'>"+esc(c.date)+"</div></div></div>"+
          "<div class='sec tac'><div class='small'>CUSTOM CABINETRY PROPOSAL</div><div class='h1'>"+esc(c.title)+"</div><div class='grad'></div>"+
          "<div class='panel'><div class='grid'><div class='kpi'><div class='kbig'>"+esc(c.totalInvestment)+"</div><div class='ksub'>INVESTMENT</div></div>"+
          "<div class='kpi'><div class='kbig'>"+esc(c.warrantyYears)+"</div><div class='ksub'>YEAR&nbsp;WARRANTY</div></div></div>"+
          "<p style='margin:0 0 10px;color:#334155'>"+esc(c.executiveSummary)+"</p><p style='margin:0;color:#64748b;font-size:14px'>"+esc(c.warrantyText)+"</p></div></div></div>";

        // PAGE 2
        html += "<div class='wrap page shadow'><h2 class='secTitle'>Design Options &amp; Layout</h2><div class='sec'>"+
          "<div class='two'><div><h3 style='margin:0 0 10px;font:600 16px system-ui;color:#0f172a'>Shaker Style</h3>"+
          blockImg(embedded.shakerRender,'Shaker Kitchen')+"<div class='cap'>"+esc(c.shakerDescription)+"</div>"+
          blockImg(embedded.shakerVanity,'Shaker Vanity')+"<div class='cap'>"+esc(c.shakerVanityDescription)+"</div></div>"+
          "<div><h3 style='margin:0 0 10px;font:600 16px system-ui;color:#0f172a'>Euro Style</h3>"+
          blockImg(embedded.euroRender,'Euro Kitchen')+"<div class='cap'>"+esc(c.euroDescription)+"</div>"+
          blockImg(embedded.euroVanity,'Euro Vanity')+"<div class='cap'>"+esc(c.euroVanityDescription)+"</div></div></div>"+
          "<div style='margin-top:18px;text-align:center'><h3 style='margin:0 0 10px;font:600 16px system-ui;color:#0f172a'>Architectural Layout</h3>"+
          blockImgTall(embedded.floorPlan)+"<div class='cap' style='margin-top:8px'>"+esc(c.floorPlanDescription)+"</div>"+
          (has(c.onlinePlansLink) ? "<div style='margin-top:10px;font-size:14px'><span style='color:#475569'>View detailed plans:</span> <a href='"+esc(c.onlinePlansLink)+"' target='_blank' rel='noreferrer' style='color:#111827;text-decoration:underline'>"+esc(c.onlinePlansLink)+"</a></div>": "")+
          (has(c.sketchupLink) ? "<div style='margin-top:14px;background:#fffbeb;border:1px solid #fde68a;padding:14px;border-radius:8px;display:inline-block'><div style='font-weight:600;margin-bottom:6px;color:#0f172a'>🏠 VIEW IN 3D</div><div style='color:#475569;font-size:14px;margin-bottom:8px'>Experience your kitchen design in full 3D.</div><a class='btn3d' href='"+esc(c.sketchupLink)+"' target='_blank' rel='noreferrer'>View 3D Model</a></div>": "")+
          "</div></div></div>";

        // PAGE 3
        const tl = (c.timeline||[]).map((t,i)=>(
          "<div class='tlItem'><div class='dot' style='background:"+tlColor(i)+"'></div><div><div class='tlP'>"+esc(t.period)+"</div><div class='tlT'>"+esc(t.task)+"</div></div></div>"
        )).join("");
        const steps = (c.nextSteps||[]).map((s,i)=>(
          "<div class='nxItem'><div class='num'>"+(i+1)+"</div><div>"+esc(s)+"</div></div>"
        )).join("");

        html += "<div class='wrap page shadow'><h2 class='secTitle'>Timeline &amp; Next Steps</h2><div class='secBody cols'>"+
          "<div><h3 style='margin:0 0 6px;font:600 16px system-ui'>Project Timeline</h3><div style='margin-top:14px'>"+tl+"</div></div>"+
          "<div><h3 style='margin:0 0 6px;font:600 16px system-ui'>Next Steps</h3><div style='margin-top:14px'>"+steps+"</div></div>"+
          "</div>"+
          "<div class='footer'><img src='"+(embedded.logo || "")+"' alt='' class='footLogo'>"+
          "<div>"+esc(c.tagline)+"</div><div class='footAddr'>"+esc(c.address)+"</div>"+
          "<div class='footThanks'>Thank you for considering Foundry Cabinet Co. We look forward to creating cabinetry that&#39;s the perfect fit for your home.</div></div></div>";

        html += "</body></html>";

        const blob = new Blob([html], {type:'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (c.projectNumber || "proposal") + "_" + (c.clientName||"Client").replace(/\s+/g,'_') + "_Proposal.html";
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      };

      // ---------- UI ----------
      return (
        <div className="w-full min-h-screen">
          {/* connectivity banner */}
          {netDown && (
            <div className="bg-amber-100 text-amber-900 text-sm py-2 px-4 text-center">
              Cloud save/load temporarily unavailable — working from local copy. Your changes are still safe on this device.
            </div>
          )}

          {/* ADMIN TOOLBAR */}
          {!isClient && (
            <header className="bg-white border-b print:hidden">
              <div className="max-w-7xl mx-auto p-4 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <img
                    src={images.logo || DEFAULT_LOGO_PATH}
                    alt=""
                    className="h-10"
                    onError={(e)=> { e.currentTarget.src = INLINE_FALLBACK_LOGO; }}
                  />
                  <div className="text-slate-800 font-medium">Full Proposal Builder — Supabase</div>
                  {currentName && <div className="ml-3 text-xs text-green-600">● Auto-saving</div>}
                </div>
                <div className="flex gap-2">
                  <button onClick={() => { const n=prompt('Name to save as:'); if(n) { setCurrentName(n.trim()); save(n.trim()); } }} className="bg-emerald-600 text-white px-4 py-2 rounded">Save</button>
                  <button onClick={async () => {
                    try {
                      const { data, error } = await db.from('proposals').select('name, created_at').order('created_at', { ascending:false });
                      if (error) throw error;
                      const names = (data||[]).map(d => d.name);
                      const pick = prompt('Type the exact name to load:\n\n' + names.join('\n'));
                      if (pick) loadOne(pick.trim());
                      setNetDown(false);
                    } catch (e) {
                      setNetDown(true);
                      alert("Load list failed (cloud). You can still use Export / Print.");
                    }
                  }} className="bg-sky-600 text-white px-4 py-2 rounded">Load</button>
                  <button onClick={exportClientHTML} className="bg-orange-600 text-white px-4 py-2 rounded">Export for Client</button>
                  {/* open client view pinned to current proposal if named */}
                  <button
                    onClick={async () => {
                      if (currentName) await save(currentName, false);
                      const url = window.location.pathname + `?client=true${currentName ? `&id=${encodeURIComponent(currentName)}` : ""}`;
                      window.open(url, '_blank');
                    }}
                    className="bg-purple-600 text-white px-4 py-2 rounded"
                  >
                    Client View
                  </button>
                  <button onClick={handlePrint} className="bg-slate-800 text-white px-4 py-2 rounded">Print / Save PDF</button>
                </div>
              </div>
            </header>
          )}

          {/* CLIENT MODE TOOLBAR */}
          {isClient && (
            <div className="bg-white shadow-sm border-b print:hidden">
              <div className="max-w-4xl mx-auto p-4 flex items-center justify-center gap-3 flex-wrap">
                <button
                  onClick={async () => {
                    const pick = prompt("Type the exact proposal name to load (or Cancel to use local copy):");
                    if (!pick) return;
                    try {
                      const { data: row, error } = await db.from("proposals").select("*").eq("name", pick.trim()).maybeSingle();
                      if (error) throw error;
                      if (!row) { alert("Not found."); return; }
                      setContent(row.content || content);
                      setImages(row.images || images);
                      await embedAllImagesInState(row.images || images, setImages, DEFAULT_LOGO_PATH);
                      alert('Loaded "' + pick.trim() + '" for client view.');
                      setNetDown(false);
                    } catch (e) {
                      setNetDown(true);
                      alert("Cloud load failed — showing local copy if available.");
                      const local = JSON.parse(localStorage.getItem(LS_BY_NAME(pick.trim())) || "null");
                      if (local) {
                        setContent(local.content);
                        setImages(local.images || images);
                        await embedAllImagesInState(local.images || images, setImages, DEFAULT_LOGO_PATH);
                      }
                    }
                  }}
                  className="bg-sky-600 text-white px-6 py-2 rounded"
                >
                  Load from Cloud
                </button>
                <button onClick={handlePrint} className="bg-slate-800 text-white px-6 py-2 rounded">Download PDF</button>
                <button onClick={exportClientHTML} className="bg-orange-600 text-white px-6 py-2 rounded">Export HTML</button>
              </div>
            </div>
          )}

          {/* EDITOR GRID */}
          {!isClient && (
            <div className="max-w-7xl mx-auto grid lg:grid-cols-3 gap-8 p-6 print:hidden">
              {/* LEFT: Content fields */}
              <div className="lg:col-span-2 bg-white p-4 rounded border card">
                <div className="grid md:grid-cols-2 gap-4">
                  <div><Label>Title</Label><Input value={content.title} onChange={e=>setField('title', e.target.value)} /></div>
                  <div><Label>Project #</Label><Input value={content.projectNumber} onChange={e=>setField('projectNumber', e.target.value)} /></div>
                  <div><Label>Date</Label><Input value={content.date} onChange={e=>setField('date', e.target.value)} /></div>
                  <div><Label>Client name</Label><Input value={content.clientName} onChange={e=>setField('clientName', e.target.value)} /></div>
                </div>
                <div className="grid md:grid-cols-2 gap-4 mt-4">
                  <div><Label>Total investment</Label><Input value={content.totalInvestment} onChange={e=>setField('totalInvestment', e.target.value)} /></div>
                  <div><Label>Warranty years</Label><Input value={content.warrantyYears} onChange={e=>setField('warrantyYears', e.target.value)} /></div>
                </div>
                <div className="mt-4"><Label>Executive summary</Label><TextArea value={content.executiveSummary} onChange={e=>setField('executiveSummary', e.target.value)} /></div>
                <div className="mt-4"><Label>Warranty text</Label><TextArea value={content.warrantyText} onChange={e=>setField('warrantyText', e.target.value)} /></div>
                <div className="grid md:grid-cols-2 gap-4 mt-4">
                  <div><Label>Shaker description</Label><TextArea value={content.shakerDescription} onChange={e=>setField('shakerDescription', e.target.value)} /></div>
                  <div><Label>Euro description</Label><TextArea value={content.euroDescription} onChange={e=>setField('euroDescription', e.target.value)} /></div>
                </div>
                <div className="grid md:grid-cols-2 gap-4 mt-4">
                  <div><Label>Shaker Vanity description</Label><TextArea value={content.shakerVanityDescription} onChange={e=>setField('shakerVanityDescription', e.target.value)} /></div>
                  <div><Label>Euro Vanity description</Label><TextArea value={content.euroVanityDescription} onChange={e=>setField('euroVanityDescription', e.target.value)} /></div>
                </div>
                <div className="mt-4"><Label>Floor plan description</Label><TextArea value={content.floorPlanDescription} onChange={e=>setField('floorPlanDescription', e.target.value)} /></div>
                <div className="grid md:grid-cols-2 gap-4 mt-4">
                  <div><Label>Online plans link</Label><Input value={content.onlinePlansLink} onChange={e=>setField('onlinePlansLink', e.target.value)} placeholder="https://…" /></div>
                  <div><Label>SketchUp 3D link</Label><Input value={content.sketchupLink} onChange={e=>setField('sketchupLink', e.target.value)} placeholder="https://…" /></div>
                </div>
                <div className="grid md:grid-cols-2 gap-4 mt-4">
                  <div><Label>Tagline</Label><Input value={content.tagline} onChange={e=>setField('tagline', e.target.value)} /></div>
                  <div><Label>Footer address</Label><Input value={content.address} onChange={e=>setField('address', e.target.value)} /></div>
                </div>
              </div>

              {/* RIGHT: Images + Timeline */}
              <div className="bg-white p-6 rounded border card space-y-7">
                <div className="font-semibold text-slate-700">Visual Assets</div>
                <div className="space-y-3">
                  {[["logo","Company Logo"],["shakerRender","Shaker Kitchen"],["euroRender","Euro Kitchen"],["shakerVanity","Shaker Vanity"],["euroVanity","Euro Vanity"],["floorPlan","Floor Plan"]].map(([k,label]) => (
                    <div key={k} className="flex items-center justify-between gap-2">
                      <span className="text-sm text-slate-700">{label}</span>
                      <input type="file" accept="image/*" onChange={e=> e.target.files[0] && onImgUpload(k, e.target.files[0])} className="text-sm"/>
                    </div>
                  ))}
                </div>

                <div>
                  <div className="font-semibold text-slate-700 mb-2">Timeline</div>
                  {content.timeline.map((t,i)=>(
                    <div key={i} className="grid grid-cols-1 md:grid-cols-12 gap-3 mb-3">
                      <Input
                        className="md:col-span-4"
                        value={t.period}
                        onChange={e=>setContent(prev=>({ ...prev, timeline: prev.timeline.map((x,idx)=> idx===i?({ ...x, period:e.target.value }):x) }))}
                      />
                      <Input
                        className="md:col-span-7"
                        value={t.task}
                        onChange={e=>setContent(prev=>({ ...prev, timeline: prev.timeline.map((x,idx)=> idx===i?({ ...x, task:e.target.value }):x) }))}
                      />
                      <div className="md:col-span-1 flex md:justify-end">
                        <button
                          className="bg-red-500 text-white text-xs rounded px-3 py-2 w-full md:w-auto"
                          onClick={()=>setContent(prev=>({ ...prev, timeline: prev.timeline.filter((_,idx)=>idx!==i) }))}
                        >
                          Remove
                        </button>
                      </div>
                    </div>
                  ))}
                  <button className="bg-slate-700 text-white text-xs rounded px-3 py-1" onClick={()=>setContent(prev=>({ ...prev, timeline:[...prev.timeline, {period:"NEW PERIOD", task:"New Task"}] }))}>+ Add</button>
                </div>

                <div>
                  <div className="font-semibold text-slate-700 mb-2">Next Steps</div>
                  {content.nextSteps.map((s,i)=>(
                    <div key={i} className="flex items-center gap-2 mb-2">
                      <Input value={s} onChange={e=>setContent(prev=>({ ...prev, nextSteps: prev.nextSteps.map((x,idx)=> idx===i? e.target.value : x) }))} />
                      <button className="bg-red-500 text-white text-xs rounded px-3 py-2" onClick={()=>setContent(prev=>({ ...prev, nextSteps: prev.nextSteps.filter((_,idx)=>idx!==i) }))}>Remove</button>
                    </div>
                  ))}
                  <button className="bg-slate-700 text-white text-xs rounded px-3 py-1" onClick={()=>setContent(prev=>({ ...prev, nextSteps:[...prev.nextSteps, "New step"] }))}>+ Add</button>
                </div>
              </div>
            </div>
          )}

          {/* PREVIEW PAGES */}
          <div className="proposal-container max-w-none mx-auto bg-white">
            {/* PAGE 1 */}
            <section className="proposal-page w-full max-w-4xl mx-auto bg-white shadow mb-8">
              <div className="px-8 pt-8 pb-3 flex justify-between items-start" style={{background:"var(--header)"}}>
                <img
                  src={images.logo || DEFAULT_LOGO_PATH}
                  alt=""
                  className="logo-clean"
                  onError={(e)=> { e.currentTarget.src = INLINE_FALLBACK_LOGO; }}
                />
                <div className="text-right text-white text-sm">
                  <div className="font-medium tracking-wide">PROJECT {content.projectNumber}</div>
                  <div className="text-slate-300">{content.date}</div>
                </div>
              </div>
              <div className="px-10 py-10 text-center">
                <div className="text-sm font-medium text-slate-600 uppercase tracking-widest mb-4">CUSTOM CABINETRY PROPOSAL</div>
                <h1 className="text-4xl font-light text-slate-800 mb-6">{content.title}</h1>
                <div className="w-24 h-px bg-gradient-to-r from-transparent via-amber-400 to-transparent mx-auto mb-6"></div>
                <div className="bg-slate-50 p-8 border-l-4 border-slate-800 text-left card">
                  <div className="grid md:grid-cols-2 gap-8 mb-6">
                    <div className="text-center">
                      <div className="text-3xl font-light text-slate-800 mb-2">{content.totalInvestment}</div>
                      <div className="text-sm text-slate-600 uppercase tracking-wide">Investment</div>
                    </div>
                    <div className="text-center">
                      <div className="text-3xl font-light text-slate-800 mb-2">{content.warrantyYears}</div>
                      <div className="text-sm text-slate-600 uppercase tracking-wide">Year Warranty</div>
                    </div>
                  </div>
                  <p className="text-base leading-relaxed text-slate-700 mb-4">{content.executiveSummary}</p>
                  <p className="text-sm text-slate-600">{content.warrantyText}</p>
                </div>
              </div>
            </section>

            {/* PAGE 2 */}
            <section className="proposal-page w-full max-w-4xl mx-auto bg-white shadow mb-8">
              <div className="border-b border-slate-200 pb-6 mb-8 px-8 pt-8">
                <div className="flex justify-between items-center">
                  <h2 className="text-2xl font-light text-slate-800 tracking-tight">Design Options & Layout</h2>
                  <div className="text-sm text-slate-500">PROJECT {content.projectNumber} | PAGE 02</div>
                </div>
              </div>
              <div className="px-8 flex-1">
                <div className="grid md:grid-cols-2 gap-10 mb-10">
                  <div className="space-y-4 text-center">
                    <h3 className="text-lg font-semibold text-slate-800 tracking-tight">Shaker Style</h3>
                    <div className="bg-slate-50 p-4 card img-frame flex items-center justify-center">
                      {images.shakerRender ? <img src={images.shakerRender} className="w-full h-full object-contain"/> : <div className="text-slate-400 text-sm">Shaker Kitchen</div>}
                    </div>
                    <p className="text-sm text-slate-600">{content.shakerDescription}</p>
                    <div className="bg-slate-50 p-4 card img-frame-sm flex items-center justify-center mt-4">
                      {images.shakerVanity ? <img src={images.shakerVanity} className="w-full h-full object-contain"/> : <div className="text-slate-400 text-sm">Shaker Vanity</div>}
                    </div>
                    <p className="text-sm text-slate-600">{content.shakerVanityDescription}</p>
                  </div>
                  <div className="space-y-4 text-center">
                    <h3 className="text-lg font-semibold text-slate-800 tracking-tight">Euro Style</h3>
                    <div className="bg-slate-50 p-4 card img-frame flex items-center justify-center">
                      {images.euroRender ? <img src={images.euroRender} className="w-full h-full object-contain"/> : <div className="text-slate-400 text-sm">Euro Kitchen</div>}
                    </div>
                    <p className="text-sm text-slate-600">{content.euroDescription}</p>
                    <div className="bg-slate-50 p-4 card img-frame-sm flex items-center justify-center mt-4">
                      {images.euroVanity ? <img src={images.euroVanity} className="w-full h-full object-contain"/> : <div className="text-slate-400 text-sm">Euro Vanity</div>}
                    </div>
                    <p className="text-sm text-slate-600">{content.euroVanityDescription}</p>
                  </div>
                </div>

                <div className="space-y-3 text-center">
                  <h3 className="text-lg font-medium text-slate-800 tracking-tight">Architectural Layout</h3>
                  <div className="bg-slate-50 p-6 card">
                    {images.floorPlan ? <img src={images.floorPlan} className="w-full img-frame-layout object-contain"/> : <div className="text-slate-400 text-sm img-frame-layout flex items-center justify-center">Floor Plan</div>}
                  </div>
                  <p className="text-slate-600 text-sm">{content.floorPlanDescription}</p>
                  {content.onlinePlansLink ? <div className="text-sm"><span className="text-slate-600">View detailed plans:</span> <a className="text-slate-800 underline" target="_blank" rel="noreferrer" href={content.onlinePlansLink}>{content.onlinePlansLink}</a></div> : null}
                  {content.sketchupLink ? <div className="bg-amber-50 border border-amber-200 p-6 mt-4 text-center card"><h4 className="text-lg font-medium text-slate-800 mb-2">🏠 VIEW IN 3D</h4><p className="text-slate-600 text-sm mb-4">Experience your kitchen design in full 3D. Rotate, zoom, and explore every detail.</p><a href={content.sketchupLink} target="_blank" rel="noreferrer" className="inline-block bg-slate-800 text-white px-6 py-2 rounded">View 3D Model</a></div> : null}
                </div>
              </div>
            </section>

            {/* PAGE 3 — Timeline & unified footer */}
            <section className="proposal-page w-full max-w-4xl mx-auto bg-white shadow mb-8">
              <div className="border-b border-slate-200 pb-6 mb-8 px-8 pt-8">
                <div className="flex justify-between items-center">
                  <h2 className="text-2xl font-light text-slate-800 tracking-tight">Timeline & Next Steps</h2>
                  <div className="text-sm text-slate-500">PROJECT {content.projectNumber} | PAGE 03</div>
                </div>
              </div>

              <div className="px-8 flex-1 flex flex-col gap-16 mt-2">
                <div>
                  <h3 className="text-lg font-medium text-slate-800 tracking-tight border-b border-slate-200 pb-3">Project Timeline</h3>
                  <div className="mt-6 space-y-4">
                    {content.timeline.map((t,i)=> (
                      <div key={i} className="flex items-start gap-3 tlItem">
                        <div className={["bg-amber-500","bg-slate-500","bg-slate-600","bg-slate-700","bg-slate-800"][i%5] + " w-4 h-4 mt-1 dot"}></div>
                        <div>
                          <div className="font-bold text-slate-800 text-sm uppercase tlP">{t.period}</div>
                          <div className="text-slate-600 mt-1 tlT">{t.task}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div>
                  <h3 className="text-lg font-medium text-slate-800 tracking-tight border-b border-slate-200 pb-3">Next Steps</h3>
                  <div className="mt-6 space-y-3">
                    {content.nextSteps.map((s,i)=> (
                      <div key={i} className="flex items-start gap-3 nxItem">
                        <div className="w-6 h-6 border-2 border-slate-800 flex items-center justify-center font-bold text-sm num">{i+1}</div>
                        <span className="text-slate-700">{s}</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Unified footer */}
              <div className="text-center p-12 mt-10" style={{background:"var(--footer)"}}>
                <img
                  src={images.logo || DEFAULT_LOGO_PATH}
                  alt=""
                  className="mx-auto mb-4"
                  style={{maxHeight:"90px", objectFit:"contain"}}
                  onError={(e)=> { e.currentTarget.src = INLINE_FALLBACK_LOGO; }}
                />
                <div className="text-white text-base mb-1 tracking-wide">{content.tagline}</div>
                <div className="text-slate-300 text-sm">{content.address}</div>
                <div className="text-slate-200 text-sm mt-4">
                  Thank you for considering Foundry Cabinet Co. We look forward to creating cabinetry that's the perfect fit for your home.
                </div>
              </div>
            </section>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
