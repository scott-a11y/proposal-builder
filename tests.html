<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proposal Builder Tests</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; }
    .test-suite { margin-bottom: 2rem; border: 1px solid #ddd; padding: 1rem; }
    .test-case { margin: 0.5rem 0; padding: 0.5rem; }
    .test-pass { background: #d4edda; color: #155724; }
    .test-fail { background: #f8d7da; color: #721c24; }
    .test-skip { background: #ffeaa7; color: #856404; }
    pre { background: #f8f9fa; padding: 0.5rem; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Proposal Builder Test Suite</h1>
  <div id="test-results"></div>

  <script>
    // Simple test framework
    class TestRunner {
      constructor() {
        this.results = [];
        this.currentSuite = null;
      }

      suite(name, fn) {
        this.currentSuite = { name, tests: [] };
        fn.call(this);
        this.results.push(this.currentSuite);
        this.currentSuite = null;
      }

      test(name, fn) {
        try {
          fn.call(this);
          this.currentSuite.tests.push({ name, status: 'pass', error: null });
        } catch (error) {
          this.currentSuite.tests.push({ name, status: 'fail', error: error.message });
        }
      }

      assert(condition, message = 'Assertion failed') {
        if (!condition) {
          throw new Error(message);
        }
      }

      assertEqual(actual, expected, message = `Expected ${expected}, got ${actual}`) {
        this.assert(actual === expected, message);
      }

      assertNotNull(value, message = 'Value should not be null') {
        this.assert(value !== null && value !== undefined, message);
      }

      render() {
        const container = document.getElementById('test-results');
        let html = '';

        for (const suite of this.results) {
          const passed = suite.tests.filter(t => t.status === 'pass').length;
          const failed = suite.tests.filter(t => t.status === 'fail').length;
          
          html += `
            <div class="test-suite">
              <h2>${suite.name} (${passed} passed, ${failed} failed)</h2>
              ${suite.tests.map(test => `
                <div class="test-case test-${test.status}">
                  <strong>${test.name}</strong>
                  ${test.error ? `<pre>Error: ${test.error}</pre>` : ''}
                </div>
              `).join('')}
            </div>
          `;
        }

        container.innerHTML = html;
      }
    }

    // Test utilities
    const mockFormData = {
      clientName: 'Test Client',
      projectName: 'Test Project',
      date: '2025-09-29',
      description: 'Test description',
      price: '25000',
      timeline: '6-8 weeks',
      notes: 'Test notes',
      sketchupLink: 'https://example.com/3d-model',
      clientSignature: '',
      signatureDate: ''
    };

    const mockImages = {
      logo: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg"><rect fill="%23000"/></svg>',
      shakerRender: '',
      euroRender: '',
      shakerVanity: '',
      euroVanity: '',
      floorPlan: ''
    };

    // Load the main application functions by creating a hidden iframe
    function loadMainApp() {
      return new Promise((resolve) => {
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = './index.html';
        iframe.onload = () => {
          // Extract needed functions from the main app
          const win = iframe.contentWindow;
          window.safe = win.safe;
          window.escapeHtml = win.escapeHtml;
          window.generateQRCode = win.generateQRCode;
          window.showUserMessage = win.showUserMessage;
          window.handleError = win.handleError;
          resolve();
        };
        document.body.appendChild(iframe);
      });
    }

    // Run tests
    const runner = new TestRunner();

    // Wait for app to load then run tests
    loadMainApp().then(() => {
      runner.suite('Utility Functions', function() {
        this.test('safe() sanitizes filenames correctly', function() {
          this.assertEqual(window.safe('Test Client'), 'Test_Client');
          this.assertEqual(window.safe('Client/Name<>:|'), 'Client_Name____');
          this.assertEqual(window.safe(''), 'Client');
        });

        this.test('escapeHtml() prevents XSS', function() {
          const xssInput = '<script>alert("xss")</script>';
          const xssExpected = '&lt;script&gt;alert(&quot;xss&quot;)&lt;/script&gt;';
          this.assertEqual(window.escapeHtml(xssInput), xssExpected);
          this.assertEqual(window.escapeHtml('Normal text'), 'Normal text');
          this.assertEqual(window.escapeHtml(''), '');
        });

        this.test('generateQRCode() returns data URL', function() {
          const result = window.generateQRCode('test');
          this.assert(result.startsWith('data:image/png;base64,'), 'Should return data URL');
        });
      });

      runner.suite('Error Handling', function() {
        this.test('showUserMessage() logs messages', function() {
          const originalLog = console.log;
          let loggedMessage = '';
          console.log = (msg) => { loggedMessage = msg; };
          
          window.showUserMessage('Test message', 'info');
          this.assert(loggedMessage.includes('Test message'), 'Should log the message');
          
          console.log = originalLog;
        });

        this.test('handleError() logs errors', function() {
          const originalError = console.error;
          let loggedError = '';
          console.error = (msg) => { loggedError = msg; };
          
          window.handleError(new Error('Test error'), 'test context');
          this.assert(loggedError.includes('test context'), 'Should log with context');
          
          console.error = originalError;
        });
      });

      runner.suite('Data Validation', function() {
        this.test('Form data structure is valid', function() {
          this.assertNotNull(mockFormData.clientName);
          this.assertNotNull(mockFormData.projectName);
          this.assert(mockFormData.price.match(/^\d+$/), 'Price should be numeric');
        });

        this.test('Images structure is valid', function() {
          this.assertNotNull(mockImages.logo);
          this.assert(mockImages.logo.startsWith('data:'), 'Logo should be data URL');
        });
      });

      runner.suite('Configuration', function() {
        this.test('Feature flags are properly configured', function() {
          // We'll need to check if features object exists in the iframe
          this.test('Skip: Cannot access features object from iframe', function() {
            // This test is skipped as we can't easily access the features object
          });
        });
      });

      runner.render();
    }).catch(error => {
      document.getElementById('test-results').innerHTML = 
        '<div class="test-suite"><h2>Test Setup Failed</h2><div class="test-case test-fail">Error: ' + error.message + '</div></div>';
    });
  </script>
</body>
</html>